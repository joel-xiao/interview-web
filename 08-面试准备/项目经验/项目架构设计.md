# 项目架构设计

> 大屏低代码编辑平台的技术架构设计文档，详细说明 BFF 架构、分层架构、核心模块、设计模式应用

**架构体系**：前端（Dashboard）+ BFF（Fusion）+ 多数据源（PostgreSQL、Elasticsearch、Forerunner、NPM）

**文件位置**：`08-面试准备/项目经验/项目架构设计.md`

**相关文档**：
- [大屏低代码编辑.md](./大屏低代码编辑.md) - 大屏项目经验总结

---

## 📋 架构概述

### 架构模式

**核心架构**：BFF 架构 + Schema 驱动 + 组件化开发 + 分层架构

**架构特点**：
- **BFF 架构**：前端（Dashboard）通过 Fusion BFF 层统一访问后端数据源，实现数据聚合与接口适配
- **Schema 驱动**：通过 JSON Schema 定义组件配置结构，实现配置化开发
- **组件化开发**：通用组件与业务组件分离，支持按需加载
- **分层架构**：前端分层 + BFF 分层 + 数据源分层，职责清晰
- **工程化落地**：设计模式、性能优化、工程化工具全链路应用

---

## 🏗️ 整体架构设计

### BFF 架构全景图

```
┌─────────────────────────────────────────────────────────────┐
│                    前端层 (Frontend Layer)                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Dashboard (Vue3 + Vite)                            │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │  │
│  │  │  编辑器界面   │  │  场景渲染     │  │ 预览模式  │ │  │
│  │  │ editor/      │  │ scene.vue    │  │ preview/ │ │  │
│  │  └──────────────┘  └──────────────┘  └──────────┘ │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │  │
│  │  │ Dashboard类  │  │  组件系统     │  │Schema系统│ │  │
│  │  │ index.js    │  │ chart/      │  │ schema/ │ │  │
│  │  └──────────────┘  └──────────────┘  └──────────┘ │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │  │
│  │  │  服务层       │  │  状态管理     │  │ 数据源   │ │  │
│  │  │ service/    │  │ store/      │  │datasource│ │  │
│  │  └──────────────┘  └──────────────┘  └──────────┘ │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │ HTTP/REST API
                             │ (端口: 6001 → 6800)
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                  BFF 层 (Backend For Frontend)               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Fusion (Node.js + Express)                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │  │
│  │  │  路由层       │  │  中间件层     │  │控制器层  │ │  │
│  │  │ routes/     │  │ middleware/ │  │controller│ │  │
│  │  │ /api/v1/*   │  │ 认证/鉴权    │  │业务逻辑  │ │  │
│  │  │ /api/v2/*   │  │ 请求预处理    │  │参数校验  │ │  │
│  │  └──────────────┘  └──────────────┘  └──────────┘ │  │
│  │  ┌──────────────────────────────────────────────┐  │  │
│  │  │  数据抽象层 (Data Abstraction Layer)         │  │  │
│  │  │  dbInterface.js - 统一数据访问接口           │  │  │
│  │  └──────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ↓                    ↓                    ↓
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ PostgreSQL    │  │ Elasticsearch │  │  Forerunner   │
│ (主存储)       │  │  (可选存储)    │  │  (上游服务)   │
│ - 配置数据     │  │ - 日志数据     │  │ - 监控数据    │
│ - 用户数据     │  │ - 监控指标     │  │ - 性能指标    │
│ - Dashboard   │  │ - Session     │  │ - 事务链路    │
└───────────────┘  └───────────────┘  └───────────────┘
        │
        ↓
┌───────────────┐
│  NPM          │
│ (网络监控)     │
│ - 网络流量     │
│ - 网络拓扑     │
└───────────────┘
```

### 前端分层架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      表现层 (Presentation Layer)              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  编辑器界面   │  │  场景渲染     │  │  预览模式     │      │
│  │ editor/      │  │ scene.vue    │  │ preview/    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      业务层 (Business Layer)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Dashboard类  │  │  组件系统     │  │ Schema系统   │      │
│  │ index.js    │  │ chart/      │  │ schema/     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  数据源管理   │  │  服务层       │  │  状态管理     │      │
│  │ datasource/ │  │ service/    │  │ store/      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      支撑层 (Support Layer)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  工具函数库   │  │  通用组件库   │  │  插件机制     │      │
│  │ util/       │  │ components/ │  │ plugin/     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 项目目录结构

**整体项目结构（前端 + BFF）**：

```
项目根目录/
├── dashboard/                    # 前端项目（Vue3 + Vite）
│   ├── src/
│   │   ├── views/dashboard/     # 大屏核心模块
│   │   │   ├── index.js         # Dashboard 核心类
│   │   │   ├── main.vue         # 主入口组件
│   │   │   ├── editor/          # 编辑器模块
│   │   │   ├── chart/           # 组件库
│   │   │   ├── schema/          # Schema 定义
│   │   │   ├── datasource/      # 数据源管理
│   │   │   └── ...
│   │   ├── store/               # 状态管理
│   │   ├── service/             # 服务层（调用 Fusion API）
│   │   │   ├── dashboard.service.js
│   │   │   └── index.js
│   │   ├── components/          # 全局通用组件
│   │   └── utils/              # 全局工具函数
│   └── ...
│
└── fusion/                       # BFF 后端项目（Node.js + Express）
    ├── src/
    │   ├── server.js            # HTTP 服务器启动
    │   ├── index.js             # 应用入口
    │   ├── routes/              # 路由层
    │   │   ├── index.js         # 路由注册
    │   │   ├── apiv1/           # API v1 路由（1500+ 路由）
    │   │   ├── apiv2/           # API v2 路由
    │   │   ├── web/             # Web 路由
    │   │   └── middleware.js    # 中间件
    │   ├── data/                # 数据层
    │   │   ├── dbInterface.js   # 数据抽象层（核心）
    │   │   ├── backend/         # 数据源适配器
    │   │   │   ├── pgsql/       # PostgreSQL 适配器
    │   │   │   ├── elasticsearch/ # Elasticsearch 适配器
    │   │   │   ├── forerunner/  # Forerunner 适配器
    │   │   │   └── npm/         # NPM 适配器
    │   │   ├── application/     # 应用数据模块
    │   │   ├── dashboard/       # Dashboard 数据模块
    │   │   ├── transaction/    # 事务数据模块
    │   │   └── ...
    │   ├── common/              # 公共服务
    │   │   ├── acl/             # 访问控制（Casbin）
    │   │   ├── jwt.js           # JWT 认证
    │   │   ├── safeapi/         # API 权限控制
    │   │   └── ...
    │   └── schedule.js          # 定时任务
    └── config/                   # 配置文件
        ├── default.js
        ├── development.js
        └── production.js
```

**前端目录结构（Dashboard）**：

```
dashboard/
├── src/
│   ├── views/dashboard/          # 大屏核心模块
│   │   ├── index.js              # Dashboard 核心类
│   │   ├── main.vue              # 主入口组件
│   │   ├── editor/               # 编辑器模块
│   │   │   ├── index.vue         # 编辑器主组件
│   │   │   ├── panels/           # 编辑器面板
│   │   │   └── components/       # 编辑器组件
│   │   ├── chart/                # 组件库
│   │   │   ├── barchart/         # 柱状图组件
│   │   │   ├── linechart/        # 折线图组件
│   │   │   ├── mapchart/         # 地图组件（业务组件）
│   │   │   ├── topology/         # 拓扑组件（业务组件）
│   │   │   └── ...               # 其他组件
│   │   ├── schema/               # Schema 定义
│   │   │   ├── index.js          # Schema 注册中心
│   │   │   ├── container.js      # 容器 Schema
│   │   │   ├── chart_style.js    # 图表样式 Schema
│   │   │   └── ...               # 其他 Schema
│   │   ├── datasource/           # 数据源管理
│   │   │   ├── index.js          # 数据源入口
│   │   │   ├── application/      # 应用数据源
│   │   │   ├── host/             # 主机数据源
│   │   │   ├── network/          # 网络数据源
│   │   │   └── util.js           # 数据源工具
│   │   ├── util/                 # 工具函数
│   │   │   ├── componentApp.js   # 组件创建工具
│   │   │   ├── grid_sizing.js    # 网格布局工具
│   │   │   └── event.js          # 事件处理工具
│   │   ├── components/           # 大屏通用组件
│   │   │   ├── preview-view.vue  # 预览组件
│   │   │   └── item-card.vue     # 卡片组件
│   │   ├── scene.vue             # 场景渲染组件
│   │   └── manage.vue            # 管理页面
│   ├── store/                    # 状态管理
│   │   ├── dashboard.js          # 大屏状态管理
│   │   └── index.js              # Store 入口
│   ├── service/                  # 服务层（调用 Fusion API）
│   │   ├── dashboard.service.js  # 大屏服务
│   │   ├── helper.js             # HTTP 请求封装
│   │   └── index.js              # Service 入口
│   ├── components/               # 全局通用组件
│   └── utils/                    # 全局工具函数
└── ...
```

**BFF 目录结构（Fusion）**：

```
fusion/
├── src/
│   ├── server.js                 # HTTP 服务器启动
│   ├── index.js                  # 应用入口
│   ├── routes/                   # 路由层
│   │   ├── index.js              # 路由注册
│   │   ├── apiv1/                # API v1 路由
│   │   │   ├── index.js          # v1 路由入口
│   │   │   ├── application/      # 应用监控路由
│   │   │   ├── transaction/      # 事务追踪路由
│   │   │   ├── dashboard/        # Dashboard 路由
│   │   │   └── ...
│   │   ├── apiv2/                # API v2 路由
│   │   ├── web/                  # Web 路由
│   │   └── middleware.js         # 中间件（认证、鉴权）
│   ├── data/                     # 数据层
│   │   ├── dbInterface.js        # 数据抽象层（核心）
│   │   ├── backend/              # 数据源适配器
│   │   │   ├── pgsql/            # PostgreSQL 适配器
│   │   │   │   └── dbImpl.js     # 数据库实现
│   │   │   ├── elasticsearch/    # Elasticsearch 适配器
│   │   │   │   └── dbImpl.js     # ES 实现
│   │   │   ├── forerunner/       # Forerunner 适配器
│   │   │   └── npm/              # NPM 适配器
│   │   ├── application/          # 应用数据模块
│   │   ├── dashboard/            # Dashboard 数据模块
│   │   ├── transaction/          # 事务数据模块
│   │   └── ...
│   ├── common/                   # 公共服务
│   │   ├── acl/                  # 访问控制
│   │   │   ├── casbin.js        # Casbin RBAC
│   │   │   └── policy.js        # 权限策略
│   │   ├── jwt.js                # JWT 认证
│   │   ├── safeapi/              # API 权限控制
│   │   └── ...
│   └── schedule.js               # 定时任务
└── config/                       # 配置文件
```

---

## 🏛️ 核心架构设计

### 1. Dashboard 核心类设计

**职责**：统一管理大屏生命周期、组件注册、场景加载

**核心方法**：
```javascript
export default class Dashboard {
  constructor() {
    this.sceneData = {};      // 场景数据缓存
    this.components = [];      // 组件注册表
    this.vmInstance = [];      // Vue 实例管理
    this.vue = null;           // Vue 应用实例
  }

  // 初始化组件系统
  async initComponents() {
    initSchemas();                    // 初始化 Schema
    this.vue = createApp();           // 创建 Vue 应用
    
    // 批量注册组件
    let components = import.meta.globEager('./chart/**/index.vue');
    for (let path of Object.keys(components)) {
      let com = components[path];
      let name = path.split("/")[2];
      this.vue.component(name, com.default);
      this.components.push({ 
        name, 
        schema: com.default.schema || com.default.name,
        target: com.default,
      });
    }
  }

  // 加载场景
  async loadScene(scene, id, saveSceneData, mode, isAutoSave, data) {
    // 1. 获取场景数据（缓存优先）
    let sceneData = this.getSceneData(id) || await service.fetchDashboardScene(id);
    
    // 2. 计算屏幕适配比例
    let scale = this.calculateScale(sceneData);
    
    // 3. 创建组件实例
    let componentInstance = this.createComponentInstance(sceneData);
    
    // 4. 渲染场景
    return this.renderScene(componentInstance, scale);
  }

  // 创建组件实例（工厂模式）
  createComponentInstance(nodeData) {
    return createAppComponent({
      node: nodeData,
      dashboard: this,
      scene: this.sceneData,
    });
  }
}
```

**设计亮点**：
- **单例模式**：Dashboard 类作为全局唯一实例
- **工厂模式**：统一组件创建入口
- **缓存机制**：场景数据缓存，提升性能
- **懒加载**：组件按需加载，减少初始包体积

---

### 2. Schema 驱动架构

**核心机制**：
```javascript
// schema/index.js - Schema 注册中心
let dashboardSchemas = {};

export function initSchemas() {
  // 1. 加载 schema 目录下的所有 Schema
  let schemas = import.meta.globEager('./**/*.js');
  for (let path of Object.keys(schemas)) {
    let schema = schemas[path].default;
    if (schema) {
      registerSchema(schema.name, schema);
    }
  }

  // 2. 加载组件目录下的 Schema
  let chartSchemas = import.meta.globEager('../chart/**/*schema.js');
  for (let path of Object.keys(chartSchemas)) {
    let schema = chartSchemas[path].default;
    if (schema) {
      registerSchema(schema.name, schema);
    }
  }
}

function registerSchema(name, schema) {
  // Schema 验证
  validateSchema(schema);
  // 注册到全局 Schema 表
  dashboardSchemas[name] = schema;
}

export function getSchema(name) {
  return cloneDeep(dashboardSchemas[name]);
}
```

**Schema 结构示例**：
```javascript
// chart/barchart/schema.js
export default {
  name: 'DASHBOARD_ECHART_BAR',
  schema: {
    layout: {
      type: 'schema',
      schema: 'DASHBOARD_LAYOUT',
      required: true,
      label: '布局',
    },
    title: {
      type: 'schema',
      schema: 'DASHBOARD_TITLE',
      required: true,
      label: '标题',
    },
    appearance: {
      type: 'schema',
      schema: 'DASHBOARD_APPEARANCE',
      label: '外观'
    },
    // ... 其他配置项
  }
}
```

**Schema 驱动优势**：
- **配置化开发**：通过 Schema 定义组件配置，无需修改代码
- **动态生成**：编辑器根据 Schema 动态生成配置面板
- **类型安全**：Schema 验证确保配置正确性
- **可扩展性**：新增组件只需添加 Schema 定义

---

### 3. 组件系统架构

**组件分类体系**：

| 层级 | 组件类型 | 目录 | 特点 | 示例 |
|------|---------|------|------|------|
| **L1** | 基础组件 | `chart/barchart/` | 单一功能，无业务逻辑 | 柱状图、折线图、饼图 |
| **L2** | 容器组件 | `chart/border-container/` | 布局容器，支持嵌套 | 边框容器、网格容器 |
| **L3** | 业务组件 | `chart/mapchart/` | 复杂业务逻辑，包含编辑器 | 地图编辑器、拓扑编辑器 |

**组件标准结构**：
```
chart/barchart/
├── index.vue          # 组件实现
├── schema.js          # Schema 定义
└── bar_schema.js      # 样式 Schema（可选）
```

**组件注册流程**：
```javascript
// 1. 组件定义（index.vue）
export default {
  name: 'barchart',
  schema: 'DASHBOARD_ECHART_BAR',  // 关联 Schema
  props: {
    node: Object,
    scene: Object,
  },
  setup(props) {
    // 组件逻辑
  }
}

// 2. 自动注册（Dashboard.initComponents）
let components = import.meta.globEager('./chart/**/index.vue');
this.vue.component(name, com.default);

// 3. 动态创建（工厂模式）
createAppComponent({ node, dashboard, scene })
```

---

### 4. 数据源架构

**数据源目录结构**：
```
datasource/
├── index.js              # 数据源统一入口
├── util.js               # 数据源工具函数
├── application/          # 应用数据源
│   ├── app_stats.js
│   └── app_kpi.js
├── host/                 # 主机数据源
│   ├── host_stats.js
│   └── host_timeseries.js
├── network/              # 网络数据源
│   ├── network_kpi.js
│   └── network_health.js
└── event/                # 事件数据源
```

**数据源适配器模式**：
```javascript
// datasource/util.js - 数据适配器
export function adaptDataSource(data, sourceType, targetFormat) {
  // 1. 数据格式转换
  let adaptedData = convertFormat(data, sourceType, targetFormat);
  
  // 2. 字段映射
  adaptedData = mapFields(adaptedData, fieldMapping);
  
  // 3. 数据清洗
  adaptedData = cleanData(adaptedData);
  
  return adaptedData;
}

// 组件中使用
export default {
  props: {
    datasource: String,    // 数据源配置
    databind: Object,     // 字段映射
  },
  async setup(props) {
    // 1. 获取原始数据
    let rawData = await getDataSource(props.datasource);
    
    // 2. 适配数据格式
    let adaptedData = adaptDataSource(rawData, 'api', 'chart');
    
    // 3. 绑定到组件
    return { data: adaptedData };
  }
}
```

---

### 5. 状态管理架构

**Store 设计**（基于 Vuex）：
```javascript
// store/dashboard.js
export default {
  namespaced: true,
  state: {
    sceneData: null,           // 场景数据
    currentNode: null,          // 当前选中节点
    sceneMode: 'view',         // 场景模式（edit/view）
    theme: null,               // 主题
    dataSource: null,           // 数据源
    // ... 其他状态
  },
  mutations: {
    SET_SCENE_DATA(state, data) {
      state.sceneData = data;
    },
    SET_CURRENT_NODE(state, node) {
      state.currentNode = node;
    },
    // ... 其他 mutations
  },
  actions: {
    async loadScene({ commit }, sceneId) {
      let sceneData = await service.fetchDashboardScene(sceneId);
      commit('SET_SCENE_DATA', sceneData);
      return sceneData;
    },
    // ... 其他 actions
  }
}
```

**状态管理优势**：
- **集中管理**：全局状态统一管理，便于维护
- **响应式更新**：状态变更自动触发视图更新
- **跨组件通信**：通过 Store 实现组件间解耦通信

---

### 6. 服务层架构

**Service 设计**：
```javascript
// service/dashboard.service.js
export default {
  // 获取场景数据
  async fetchDashboardScene(id) {
    return await http.get(`/api/dashboard/scene/${id}`);
  },
  
  // 保存场景数据
  async saveDashboardScene(id, sceneData) {
    return await http.post(`/api/dashboard/scene/${id}`, sceneData);
  },
  
  // 获取数据源数据
  async fetchDataSource(sourceConfig) {
    return await http.post('/api/datasource/fetch', sourceConfig);
  },
  
  // ... 其他服务方法
}
```

**服务层优势**：
- **统一接口**：所有 API 请求统一管理
- **错误处理**：统一错误处理和异常兜底
- **请求拦截**：统一请求拦截和响应处理

---

### 7. BFF 架构设计（Fusion 后端）

**BFF（Backend For Frontend）架构**：前端通过 Fusion BFF 层统一访问后端数据源，实现数据聚合与接口适配

#### 7.1 BFF 架构概述

**架构定位**：
- **数据聚合层**：聚合多个后端数据源（PostgreSQL、Elasticsearch、Forerunner、NPM）
- **接口适配层**：将后端数据格式转换为前端所需格式
- **业务逻辑层**：处理前端特有的业务逻辑，减少前端复杂度

**技术栈**：
- **运行时**：Node.js v16+
- **Web 框架**：Express.js
- **数据存储**：PostgreSQL（主存储）、Elasticsearch（可选）
- **认证授权**：JWT、Session、Casbin（RBAC）

#### 7.2 BFF 分层架构

**Fusion 分层结构**：
```
┌─────────────────────────────────────────────────────────────┐
│                   接入层 (Server Layer)                      │
│  - HTTP 服务器启动                                          │
│  - 全局中间件加载（Helmet、BodyParser、CookieParser）      │
│  - Session 存储初始化                                        │
│  - 静态资源托管                                              │
│  - 文件上传处理                                              │
└────────────────────┬──────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                   路由层 (Routes Layer)                     │
│  - /api/v1/* 主要业务接口（1500+ 路由）                     │
│  - /api/v2/* 新特性接口                                     │
│  - /* Web 页面和 SSO 认证                                   │
└────────────────────┬──────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                 中间件层 (Middleware Layer)                 │
│  - 认证：Session/JWT 验证                                   │
│  - 鉴权：Casbin RBAC、SafeAPI 权限控制                      │
│  - 租户隔离：多租户数据隔离                                 │
│  - 请求预处理：参数校验、请求拦截                           │
└────────────────────┬──────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│               业务逻辑层 (Business Logic Layer)              │
│  - 参数校验（Joi Schema）                                   │
│  - 业务逻辑处理                                             │
│  - 数据转换与格式化                                         │
│  - 错误处理                                                 │
└────────────────────┬──────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│             数据抽象层 (Data Abstraction Layer)              │
│  - dbInterface.js：统一数据访问接口                          │
│  - 存储引擎透明切换                                         │
│  - 多数据源适配                                             │
└────────────────────┬──────────────────────────────────────┘
                     ↓
        ┌────────────┼────────────┐
        ↓            ↓            ↓
  PostgreSQL  Elasticsearch  Forerunner/NPM
```

#### 7.3 数据抽象层设计

**核心机制**：通过 `dbInterface.js` 实现存储引擎透明切换

**实现方式**：
```javascript
// src/data/dbInterface.js
const config = require('config');
const enablePgsql = config.get('pgsql.enable');

let dbImpl;
if (enablePgsql) {
  dbImpl = require('./backend/pgsql/dbImpl');
} else {
  dbImpl = require('./backend/elasticsearch/dbImpl');
}

const DBInterfaces = [{
  ...dbImpl
}];

module.exports = {
  DBInterfaces,
};
```

**数据适配器**：
- **PostgreSQL 适配器**（`backend/pgsql/`）：主存储，用于配置数据、用户数据、Dashboard 配置
- **Elasticsearch 适配器**（`backend/elasticsearch/`）：可选存储，用于日志数据、监控指标
- **Forerunner 适配器**（`backend/forerunner/`）：上游服务，用于应用监控数据聚合
- **NPM 适配器**（`backend/npm/`）：网络监控服务，用于网络流量、拓扑数据

**设计优势**：
- **存储引擎透明切换**：业务层代码无需修改即可切换存储引擎
- **统一接口定义**：所有数据访问通过统一接口
- **多数据源混合使用**：支持同时使用多个数据源

#### 7.4 API 版本管理

**版本策略**：
- **API v1**：稳定版本，向后兼容，1500+ 路由
  - 应用监控：`/api/v1/app/*`
  - 事务追踪：`/api/v1/transaction/*`
  - Dashboard：`/api/v1/dashboard/*`
  - 报表：`/api/v1/report/*`
  - 网络监控：`/api/v1/npm/*`
  
- **API v2**：新特性版本，优化接口设计
  - 更细粒度的数据查询
  - 改进的响应格式
  - 性能优化

**路由注册**：
```javascript
// src/routes/index.js
function registerApiRoutes(app) {
  app.use('/api/v1', apiv1);  // 稳定版本
  app.use('/api/v2', apiv2);  // 新特性版本
  app.use('', web);            // Web 路由
}
```

#### 7.5 认证与鉴权架构

**认证机制**：
- **Session 认证**：基于 `express-session`，支持 ES 或 Memory Store
- **JWT 认证**：基于 `jsonwebtoken`，用于 API 调用
- **SSO 认证**：支持 CAS、TAC、P13 等 SSO 协议

**鉴权机制**：
- **Casbin RBAC**：基于角色的访问控制
  - 策略管理：`src/common/acl/policy.js`
  - 权限验证：`src/common/acl/casbin.js`
- **SafeAPI**：API 级别的权限控制
  - API 权限配置：`src/common/safeapi/`
  - 权限拦截：`src/common/safeapi/index.js`

**多租户支持**：
- **租户隔离**：数据按租户隔离
- **权限隔离**：不同租户权限独立
- **数据隔离**：租户数据完全隔离

#### 7.6 前后端通信架构

**前端服务层调用**：
```javascript
// dashboard/src/service/dashboard.service.js
import helper from './helper';

function fetchDashboard(options = {}) {
  return helper.ajaxGet('dashboard', options).catch(r => []);
}

function updateDashboard(options = {}) {
  return helper.ajaxPost('dashboard', options).catch(r => []);
}
```

**请求流程**：
```
前端组件
  ↓
Service 层 (service/dashboard.service.js)
  ↓
HTTP 请求 (Axios)
  ↓
Fusion BFF (端口: 6800)
  ↓
路由层 (/api/v1/dashboard/*)
  ↓
中间件层 (认证/鉴权)
  ↓
业务逻辑层 (参数校验、业务处理)
  ↓
数据抽象层 (dbInterface)
  ↓
数据源适配器 (PostgreSQL/ES/Forerunner)
  ↓
数据源
```

#### 7.7 数据聚合与适配

**数据聚合场景**：
- **多源数据合并**：从 PostgreSQL、Elasticsearch、Forerunner 多个数据源获取数据并合并
- **数据格式转换**：将后端数据格式转换为前端所需格式
- **字段映射**：统一字段名称，适配前端组件需求

**适配器模式应用**：
```javascript
// Fusion 数据适配示例
async function fetchDashboardData(dashboardId) {
  // 1. 从 PostgreSQL 获取 Dashboard 配置
  let config = await dbImpl.getDashboardConfig(dashboardId);
  
  // 2. 从 Forerunner 获取监控数据
  let metrics = await forerunnerAdapter.getMetrics(config.metricIds);
  
  // 3. 从 Elasticsearch 获取日志数据（可选）
  let logs = await esAdapter.getLogs(config.logQuery);
  
  // 4. 数据聚合与格式转换
  return {
    config,
    metrics: adaptMetrics(metrics),
    logs: adaptLogs(logs)
  };
}
```

#### 7.8 BFF 架构优势

**前端优势**：
- **接口统一**：前端只需调用 Fusion API，无需关心后端数据源
- **数据格式适配**：BFF 层完成数据格式转换，前端直接使用
- **减少前端复杂度**：业务逻辑在 BFF 层处理，前端更轻量

**后端优势**：
- **数据源解耦**：前端与后端数据源解耦，数据源变更不影响前端
- **性能优化**：BFF 层可以缓存、聚合数据，减少前端请求次数
- **安全控制**：统一在 BFF 层进行认证、鉴权、数据过滤

**架构优势**：
- **可扩展性**：新增数据源只需添加适配器，无需修改前端代码
- **可维护性**：前后端职责清晰，便于维护和迭代
- **团队协作**：前后端团队可以并行开发，通过 API 契约协作

---

### 8. 编辑器架构

**编辑器核心组件**：
```javascript
// editor/index.vue - 编辑器主组件
export default {
  components: {
    ToolbarPanel,        // 工具栏面板
    MyComponentsPanel,   // 组件库面板
    CategoryPanel,       // 分类面板
    PropertyPanel,       // 属性配置面板
    LayerPanel,          // 图层面板
  },
  data() {
    return {
      sceneMode: 'edit',  // 编辑模式
      currentNode: null,  // 当前选中节点
      showPanels: {       // 面板显示控制
        com: true,        // 组件库
        layer: true,      // 图层
        property: true,   // 属性
      }
    }
  },
  methods: {
    // 组件拖拽添加
    onComClick(component) {
      this.addComponent(component);
    },
    // 节点选中
    onNodeSelect(node) {
      this.currentNode = node;
      this.showPropertyPanel(node);
    },
    // 保存场景
    async onSave() {
      let sceneData = this.getSceneData();
      await service.saveDashboardScene(this.dashboardId, sceneData);
    }
  }
}
```

**编辑器功能模块**：
- **工具栏**：保存、预览、导出、全屏等操作
- **组件库**：组件分类展示，支持拖拽添加
- **属性面板**：根据 Schema 动态生成配置表单
- **图层面板**：组件树形结构，支持拖拽排序
- **画布区域**：可视化编辑区域，支持拖拽、缩放、对齐

---

### 9. 数据流架构

**完整数据流向图（包含 BFF 层）**：
```
用户操作
  ↓
编辑器组件 (editor/index.vue)
  ↓
Dashboard 类 (index.js)
  ↓
┌─────────────┬─────────────┬─────────────┐
│  Schema系统  │  组件系统    │  数据源系统  │
│  schema/    │  chart/     │  datasource/│
└─────────────┴─────────────┴─────────────┘
  ↓
Store (store/dashboard.js)
  ↓
Service (service/dashboard.service.js)
  ↓
HTTP 请求 (Axios)
  ↓
┌─────────────────────────────────────────┐
│  Fusion BFF 层                          │
│  ┌─────────────┬─────────────┬─────────┐ │
│  │  路由层     │  中间件层   │业务逻辑层│ │
│  │ /api/v1/*  │ 认证/鉴权   │参数校验 │ │
│  └─────────────┴─────────────┴─────────┘ │
│  ┌─────────────────────────────────────┐ │
│  │  数据抽象层 (dbInterface)           │ │
│  └─────────────────────────────────────┘ │
└────────────┬──────────────────────────────┘
             │
    ┌────────┼────────┐
    ↓        ↓        ↓
PostgreSQL  ES    Forerunner/NPM
```

**数据更新流程**：
1. **用户操作** → 编辑器捕获用户操作（拖拽、配置等）
2. **状态更新** → 更新 Store 中的场景数据
3. **组件响应** → 组件监听状态变化，自动更新
4. **API 请求** → Service 层发起 HTTP 请求到 Fusion BFF
5. **BFF 处理** → Fusion 层进行认证、鉴权、业务逻辑处理
6. **数据聚合** → BFF 层从多个数据源聚合数据
7. **数据适配** → BFF 层将数据格式转换为前端所需格式
8. **响应返回** → 前端接收数据，更新视图

**数据获取流程**：
1. **前端请求** → Service 层调用 `fetchDashboardScene(id)`
2. **HTTP 请求** → 发送到 `http://fusion:6800/api/v1/dashboard/scene/${id}`
3. **路由匹配** → Fusion 路由层匹配到对应 Controller
4. **中间件处理** → 认证、鉴权、参数校验
5. **业务逻辑** → Controller 处理业务逻辑
6. **数据访问** → 通过 `dbInterface` 访问数据源
7. **数据聚合** → 从 PostgreSQL、Forerunner 等多个数据源获取数据
8. **数据适配** → 将数据格式转换为前端所需格式
9. **响应返回** → 返回 JSON 数据给前端
10. **前端更新** → 前端接收数据，更新 Store 和视图

---

### 10. 组件生命周期

**组件生命周期管理**：
```javascript
// Dashboard 类中的组件生命周期
class Dashboard {
  // 创建组件实例
  createComponent(nodeData) {
    let component = createAppComponent({
      node: nodeData,
      dashboard: this,
      scene: this.sceneData,
    });
    
    // 注册生命周期钩子
    component.onMounted(() => {
      this.loadComponentData(component);
    });
    
    component.onUpdated(() => {
      this.updateComponentData(component);
    });
    
    component.onUnmounted(() => {
      this.destroyComponent(component);
    });
    
    return component;
  }
  
  // 加载组件数据
  async loadComponentData(component) {
    if (component.props.datasource) {
      let data = await this.fetchDataSource(component.props.datasource);
      component.setData(data);
    }
  }
}
```

**生命周期阶段**：
1. **创建阶段**：根据 Schema 创建组件实例
2. **挂载阶段**：组件挂载到 DOM，加载数据源
3. **更新阶段**：配置变更触发组件更新
4. **销毁阶段**：组件卸载，清理资源

---

## 🎨 设计模式在架构中的应用

### 1. 单例模式

**应用场景**：Dashboard 核心类、Schema 注册中心

**实现方式**：
```javascript
// Dashboard 单例
class Dashboard {
  static instance = null;
  
  static getInstance() {
    if (!Dashboard.instance) {
      Dashboard.instance = new Dashboard();
    }
    return Dashboard.instance;
  }
}
```

**作用**：确保全局唯一实例，统一管理大屏生命周期

---

### 2. 工厂模式

**应用场景**：组件创建、数据源创建

**实现方式**：
```javascript
// 组件工厂
function createAppComponent(config) {
  const { node, dashboard, scene } = config;
  const Component = getComponent(node.type);
  return new Component({ node, dashboard, scene });
}

// 数据源工厂
function createDataSource(sourceType) {
  switch(sourceType) {
    case 'application': return new ApplicationDataSource();
    case 'host': return new HostDataSource();
    case 'network': return new NetworkDataSource();
    default: throw new Error('Unknown data source type');
  }
}
```

**作用**：统一创建入口，降低创建复杂度

---

### 3. 观察者模式

**应用场景**：组件状态变更、事件总线

**实现方式**：
```javascript
// 事件总线
class EventBus {
  constructor() {
    this.events = {};
  }
  
  on(event, callback) {
    if (!this.events[event]) {
      this.events[event] = [];
    }
    this.events[event].push(callback);
  }
  
  emit(event, data) {
    if (this.events[event]) {
      this.events[event].forEach(callback => callback(data));
    }
  }
}
```

**作用**：实现组件间解耦通信，支持全局联动

---

### 4. 代理模式

**应用场景**：组件属性代理、数据源代理

**实现方式**：
```javascript
// 属性代理
function createPropertyProxy(target, handler) {
  return new Proxy(target, {
    set(obj, prop, value) {
      // 拦截属性更新
      if (handler.beforeSet) {
        value = handler.beforeSet(prop, value);
      }
      obj[prop] = value;
      // 触发更新
      if (handler.onSet) {
        handler.onSet(prop, value);
      }
      return true;
    }
  });
}
```

**作用**：属性操作规范可控，拦截属性更新

---

### 5. 适配器模式

**应用场景**：数据源适配、组件接口适配

**实现方式**：
```javascript
// 数据源适配器
class DataSourceAdapter {
  adapt(data, sourceFormat, targetFormat) {
    // 格式转换
    let converted = this.convertFormat(data, sourceFormat, targetFormat);
    // 字段映射
    converted = this.mapFields(converted);
    // 数据清洗
    converted = this.cleanData(converted);
    return converted;
  }
}
```

**作用**：统一数据接口，屏蔽底层数据差异

---

### 6. 装饰器模式

**应用场景**：Layout 渲染、组件功能增强

**实现方式**：
```javascript
// Layout 装饰器
function withLayout(Component) {
  return {
    ...Component,
    render() {
      return (
        <LayoutContainer>
          <Component {...this.$props} />
        </LayoutContainer>
      );
    }
  };
}
```

**作用**：不侵入业务组件代码，实现功能增强

---

## 📊 架构设计原则

### 1. 分层原则

**清晰分层**：
- **表现层**：负责用户交互和界面展示
- **业务层**：负责业务逻辑和核心功能
- **数据层**：负责数据管理和状态同步
- **支撑层**：提供工具和基础设施

**职责分离**：每层只关注自己的职责，降低耦合度

---

### 2. 高内聚低耦合

**高内聚**：
- 相关功能集中在同一模块
- 组件内部功能紧密相关
- Schema 定义与组件实现绑定

**低耦合**：
- 模块间通过接口通信
- 使用事件总线解耦组件
- 依赖注入而非硬编码依赖

---

### 3. 可扩展性

**扩展机制**：
- **插件机制**：支持功能插件化扩展
- **组件注册**：动态注册新组件
- **Schema 扩展**：通过 Schema 扩展配置项

**扩展方式**：
- 新增组件：添加组件文件和 Schema 定义
- 新增功能：通过插件机制注入
- 新增数据源：实现数据源接口

---

### 4. 可维护性

**维护策略**：
- **清晰结构**：目录结构清晰，职责明确
- **规范命名**：统一的命名规范
- **完善文档**：代码注释和架构文档
- **测试覆盖**：关键模块有测试保障

---

## 🎯 BFF 架构总结

### BFF 架构核心价值

**解决的问题**：
1. **多数据源聚合**：前端需要从多个后端数据源（PostgreSQL、Elasticsearch、Forerunner、NPM）获取数据
2. **数据格式适配**：不同数据源返回格式不一致，需要统一转换为前端所需格式
3. **接口复杂度**：前端直接调用多个后端服务，接口复杂，维护困难
4. **安全控制**：需要在统一层进行认证、鉴权、数据过滤

**BFF 架构优势**：
- **前端简化**：前端只需调用 Fusion API，无需关心后端数据源细节
- **数据聚合**：BFF 层聚合多个数据源，减少前端请求次数
- **格式统一**：BFF 层统一数据格式，前端直接使用
- **安全集中**：统一在 BFF 层进行认证、鉴权、数据过滤
- **解耦设计**：前端与后端数据源解耦，数据源变更不影响前端

### BFF 架构设计要点

1. **数据抽象层**：通过 `dbInterface.js` 实现存储引擎透明切换
2. **适配器模式**：不同数据源通过适配器统一接口
3. **API 版本管理**：v1 稳定版本，v2 新特性版本
4. **认证鉴权**：Session、JWT、Casbin RBAC 多层级安全控制
5. **多租户支持**：租户隔离、权限隔离、数据隔离

---

## 🔗 相关文档

- [大屏低代码编辑.md](./大屏低代码编辑.md) - 大屏项目经验总结
- [前端架构.md](../../06-工程化/前端架构.md) - 前端架构设计核心体系
- [Design pattern.md](../../01-JavaScript基础/Design pattern.md) - JavaScript 设计模式详解

