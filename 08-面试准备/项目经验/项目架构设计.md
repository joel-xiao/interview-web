# 项目架构设计

> 大屏低代码编辑平台的技术架构设计文档，详细说明分层架构、核心模块、设计模式应用

**文件位置**：`08-面试准备/项目经验/项目架构设计.md`

**相关文档**：
- [大屏低代码编辑.md](./大屏低代码编辑.md) - 大屏项目经验总结

---

## 📋 架构概述

### 架构模式

**核心架构**：Schema 驱动 + 组件化开发 + 分层架构

**架构特点**：
- **Schema 驱动**：通过 JSON Schema 定义组件配置结构，实现配置化开发
- **组件化开发**：通用组件与业务组件分离，支持按需加载
- **分层架构**：组件层、支撑层、数据层清晰分离，职责明确
- **工程化落地**：设计模式、性能优化、工程化工具全链路应用

---

## 🏗️ 整体架构设计

### 架构分层图

```
┌─────────────────────────────────────────────────────────────┐
│                      表现层 (Presentation Layer)              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  编辑器界面   │  │  场景渲染     │  │  预览模式     │      │
│  │ editor/      │  │ scene.vue    │  │ preview/    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      业务层 (Business Layer)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Dashboard类  │  │  组件系统     │  │ Schema系统   │      │
│  │ index.js    │  │ chart/      │  │ schema/     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  数据源管理   │  │  服务层       │  │  状态管理     │      │
│  │ datasource/ │  │ service/    │  │ store/      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      支撑层 (Support Layer)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  工具函数库   │  │  通用组件库   │  │  插件机制     │      │
│  │ util/       │  │ components/ │  │ plugin/     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 项目目录结构

```
dashboard/
├── src/
│   ├── views/dashboard/          # 大屏核心模块
│   │   ├── index.js              # Dashboard 核心类
│   │   ├── main.vue              # 主入口组件
│   │   ├── editor/               # 编辑器模块
│   │   │   ├── index.vue         # 编辑器主组件
│   │   │   ├── panels/           # 编辑器面板
│   │   │   └── components/       # 编辑器组件
│   │   ├── chart/                # 组件库
│   │   │   ├── barchart/         # 柱状图组件
│   │   │   ├── linechart/        # 折线图组件
│   │   │   ├── mapchart/         # 地图组件（业务组件）
│   │   │   ├── topology/         # 拓扑组件（业务组件）
│   │   │   └── ...               # 其他组件
│   │   ├── schema/               # Schema 定义
│   │   │   ├── index.js          # Schema 注册中心
│   │   │   ├── container.js      # 容器 Schema
│   │   │   ├── chart_style.js    # 图表样式 Schema
│   │   │   └── ...               # 其他 Schema
│   │   ├── datasource/           # 数据源管理
│   │   │   ├── index.js          # 数据源入口
│   │   │   ├── application/      # 应用数据源
│   │   │   ├── host/             # 主机数据源
│   │   │   ├── network/          # 网络数据源
│   │   │   └── util.js           # 数据源工具
│   │   ├── util/                 # 工具函数
│   │   │   ├── componentApp.js   # 组件创建工具
│   │   │   ├── grid_sizing.js    # 网格布局工具
│   │   │   └── event.js          # 事件处理工具
│   │   ├── components/           # 大屏通用组件
│   │   │   ├── preview-view.vue  # 预览组件
│   │   │   └── item-card.vue     # 卡片组件
│   │   ├── scene.vue             # 场景渲染组件
│   │   └── manage.vue            # 管理页面
│   ├── store/                    # 状态管理
│   │   ├── dashboard.js          # 大屏状态管理
│   │   └── index.js              # Store 入口
│   ├── service/                  # 服务层
│   │   ├── dashboard.service.js  # 大屏服务
│   │   └── index.js              # Service 入口
│   ├── components/               # 全局通用组件
│   └── utils/                    # 全局工具函数
└── ...
```

---

## 🏛️ 核心架构设计

### 1. Dashboard 核心类设计

**职责**：统一管理大屏生命周期、组件注册、场景加载

**核心方法**：
```javascript
export default class Dashboard {
  constructor() {
    this.sceneData = {};      // 场景数据缓存
    this.components = [];      // 组件注册表
    this.vmInstance = [];      // Vue 实例管理
    this.vue = null;           // Vue 应用实例
  }

  // 初始化组件系统
  async initComponents() {
    initSchemas();                    // 初始化 Schema
    this.vue = createApp();           // 创建 Vue 应用
    
    // 批量注册组件
    let components = import.meta.globEager('./chart/**/index.vue');
    for (let path of Object.keys(components)) {
      let com = components[path];
      let name = path.split("/")[2];
      this.vue.component(name, com.default);
      this.components.push({ 
        name, 
        schema: com.default.schema || com.default.name,
        target: com.default,
      });
    }
  }

  // 加载场景
  async loadScene(scene, id, saveSceneData, mode, isAutoSave, data) {
    // 1. 获取场景数据（缓存优先）
    let sceneData = this.getSceneData(id) || await service.fetchDashboardScene(id);
    
    // 2. 计算屏幕适配比例
    let scale = this.calculateScale(sceneData);
    
    // 3. 创建组件实例
    let componentInstance = this.createComponentInstance(sceneData);
    
    // 4. 渲染场景
    return this.renderScene(componentInstance, scale);
  }

  // 创建组件实例（工厂模式）
  createComponentInstance(nodeData) {
    return createAppComponent({
      node: nodeData,
      dashboard: this,
      scene: this.sceneData,
    });
  }
}
```

**设计亮点**：
- **单例模式**：Dashboard 类作为全局唯一实例
- **工厂模式**：统一组件创建入口
- **缓存机制**：场景数据缓存，提升性能
- **懒加载**：组件按需加载，减少初始包体积

---

### 2. Schema 驱动架构

**核心机制**：
```javascript
// schema/index.js - Schema 注册中心
let dashboardSchemas = {};

export function initSchemas() {
  // 1. 加载 schema 目录下的所有 Schema
  let schemas = import.meta.globEager('./**/*.js');
  for (let path of Object.keys(schemas)) {
    let schema = schemas[path].default;
    if (schema) {
      registerSchema(schema.name, schema);
    }
  }

  // 2. 加载组件目录下的 Schema
  let chartSchemas = import.meta.globEager('../chart/**/*schema.js');
  for (let path of Object.keys(chartSchemas)) {
    let schema = chartSchemas[path].default;
    if (schema) {
      registerSchema(schema.name, schema);
    }
  }
}

function registerSchema(name, schema) {
  // Schema 验证
  validateSchema(schema);
  // 注册到全局 Schema 表
  dashboardSchemas[name] = schema;
}

export function getSchema(name) {
  return cloneDeep(dashboardSchemas[name]);
}
```

**Schema 结构示例**：
```javascript
// chart/barchart/schema.js
export default {
  name: 'DASHBOARD_ECHART_BAR',
  schema: {
    layout: {
      type: 'schema',
      schema: 'DASHBOARD_LAYOUT',
      required: true,
      label: '布局',
    },
    title: {
      type: 'schema',
      schema: 'DASHBOARD_TITLE',
      required: true,
      label: '标题',
    },
    appearance: {
      type: 'schema',
      schema: 'DASHBOARD_APPEARANCE',
      label: '外观'
    },
    // ... 其他配置项
  }
}
```

**Schema 驱动优势**：
- **配置化开发**：通过 Schema 定义组件配置，无需修改代码
- **动态生成**：编辑器根据 Schema 动态生成配置面板
- **类型安全**：Schema 验证确保配置正确性
- **可扩展性**：新增组件只需添加 Schema 定义

---

### 3. 组件系统架构

**组件分类体系**：

| 层级 | 组件类型 | 目录 | 特点 | 示例 |
|------|---------|------|------|------|
| **L1** | 基础组件 | `chart/barchart/` | 单一功能，无业务逻辑 | 柱状图、折线图、饼图 |
| **L2** | 容器组件 | `chart/border-container/` | 布局容器，支持嵌套 | 边框容器、网格容器 |
| **L3** | 业务组件 | `chart/mapchart/` | 复杂业务逻辑，包含编辑器 | 地图编辑器、拓扑编辑器 |

**组件标准结构**：
```
chart/barchart/
├── index.vue          # 组件实现
├── schema.js          # Schema 定义
└── bar_schema.js      # 样式 Schema（可选）
```

**组件注册流程**：
```javascript
// 1. 组件定义（index.vue）
export default {
  name: 'barchart',
  schema: 'DASHBOARD_ECHART_BAR',  // 关联 Schema
  props: {
    node: Object,
    scene: Object,
  },
  setup(props) {
    // 组件逻辑
  }
}

// 2. 自动注册（Dashboard.initComponents）
let components = import.meta.globEager('./chart/**/index.vue');
this.vue.component(name, com.default);

// 3. 动态创建（工厂模式）
createAppComponent({ node, dashboard, scene })
```

---

### 4. 数据源架构

**数据源目录结构**：
```
datasource/
├── index.js              # 数据源统一入口
├── util.js               # 数据源工具函数
├── application/          # 应用数据源
│   ├── app_stats.js
│   └── app_kpi.js
├── host/                 # 主机数据源
│   ├── host_stats.js
│   └── host_timeseries.js
├── network/              # 网络数据源
│   ├── network_kpi.js
│   └── network_health.js
└── event/                # 事件数据源
```

**数据源适配器模式**：
```javascript
// datasource/util.js - 数据适配器
export function adaptDataSource(data, sourceType, targetFormat) {
  // 1. 数据格式转换
  let adaptedData = convertFormat(data, sourceType, targetFormat);
  
  // 2. 字段映射
  adaptedData = mapFields(adaptedData, fieldMapping);
  
  // 3. 数据清洗
  adaptedData = cleanData(adaptedData);
  
  return adaptedData;
}

// 组件中使用
export default {
  props: {
    datasource: String,    // 数据源配置
    databind: Object,     // 字段映射
  },
  async setup(props) {
    // 1. 获取原始数据
    let rawData = await getDataSource(props.datasource);
    
    // 2. 适配数据格式
    let adaptedData = adaptDataSource(rawData, 'api', 'chart');
    
    // 3. 绑定到组件
    return { data: adaptedData };
  }
}
```

---

### 5. 状态管理架构

**Store 设计**（基于 Vuex）：
```javascript
// store/dashboard.js
export default {
  namespaced: true,
  state: {
    sceneData: null,           // 场景数据
    currentNode: null,          // 当前选中节点
    sceneMode: 'view',         // 场景模式（edit/view）
    theme: null,               // 主题
    dataSource: null,           // 数据源
    // ... 其他状态
  },
  mutations: {
    SET_SCENE_DATA(state, data) {
      state.sceneData = data;
    },
    SET_CURRENT_NODE(state, node) {
      state.currentNode = node;
    },
    // ... 其他 mutations
  },
  actions: {
    async loadScene({ commit }, sceneId) {
      let sceneData = await service.fetchDashboardScene(sceneId);
      commit('SET_SCENE_DATA', sceneData);
      return sceneData;
    },
    // ... 其他 actions
  }
}
```

**状态管理优势**：
- **集中管理**：全局状态统一管理，便于维护
- **响应式更新**：状态变更自动触发视图更新
- **跨组件通信**：通过 Store 实现组件间解耦通信

---

### 6. 服务层架构

**Service 设计**：
```javascript
// service/dashboard.service.js
export default {
  // 获取场景数据
  async fetchDashboardScene(id) {
    return await http.get(`/api/dashboard/scene/${id}`);
  },
  
  // 保存场景数据
  async saveDashboardScene(id, sceneData) {
    return await http.post(`/api/dashboard/scene/${id}`, sceneData);
  },
  
  // 获取数据源数据
  async fetchDataSource(sourceConfig) {
    return await http.post('/api/datasource/fetch', sourceConfig);
  },
  
  // ... 其他服务方法
}
```

**服务层优势**：
- **统一接口**：所有 API 请求统一管理
- **错误处理**：统一错误处理和异常兜底
- **请求拦截**：统一请求拦截和响应处理

---

### 7. 编辑器架构

**编辑器核心组件**：
```javascript
// editor/index.vue - 编辑器主组件
export default {
  components: {
    ToolbarPanel,        // 工具栏面板
    MyComponentsPanel,   // 组件库面板
    CategoryPanel,       // 分类面板
    PropertyPanel,       // 属性配置面板
    LayerPanel,          // 图层面板
  },
  data() {
    return {
      sceneMode: 'edit',  // 编辑模式
      currentNode: null,  // 当前选中节点
      showPanels: {       // 面板显示控制
        com: true,        // 组件库
        layer: true,      // 图层
        property: true,   // 属性
      }
    }
  },
  methods: {
    // 组件拖拽添加
    onComClick(component) {
      this.addComponent(component);
    },
    // 节点选中
    onNodeSelect(node) {
      this.currentNode = node;
      this.showPropertyPanel(node);
    },
    // 保存场景
    async onSave() {
      let sceneData = this.getSceneData();
      await service.saveDashboardScene(this.dashboardId, sceneData);
    }
  }
}
```

**编辑器功能模块**：
- **工具栏**：保存、预览、导出、全屏等操作
- **组件库**：组件分类展示，支持拖拽添加
- **属性面板**：根据 Schema 动态生成配置表单
- **图层面板**：组件树形结构，支持拖拽排序
- **画布区域**：可视化编辑区域，支持拖拽、缩放、对齐

---

### 8. 数据流架构

**数据流向图**：
```
用户操作
  ↓
编辑器组件 (editor/index.vue)
  ↓
Dashboard 类 (index.js)
  ↓
┌─────────────┬─────────────┬─────────────┐
│  Schema系统  │  组件系统    │  数据源系统  │
│  schema/    │  chart/     │  datasource/│
└─────────────┴─────────────┴─────────────┘
  ↓
Store (store/dashboard.js)
  ↓
Service (service/dashboard.service.js)
  ↓
后端 API
```

**数据更新流程**：
1. **用户操作** → 编辑器捕获用户操作（拖拽、配置等）
2. **状态更新** → 更新 Store 中的场景数据
3. **组件响应** → 组件监听状态变化，自动更新
4. **数据同步** → Service 层同步数据到后端
5. **视图渲染** → 场景组件重新渲染

---

### 9. 组件生命周期

**组件生命周期管理**：
```javascript
// Dashboard 类中的组件生命周期
class Dashboard {
  // 创建组件实例
  createComponent(nodeData) {
    let component = createAppComponent({
      node: nodeData,
      dashboard: this,
      scene: this.sceneData,
    });
    
    // 注册生命周期钩子
    component.onMounted(() => {
      this.loadComponentData(component);
    });
    
    component.onUpdated(() => {
      this.updateComponentData(component);
    });
    
    component.onUnmounted(() => {
      this.destroyComponent(component);
    });
    
    return component;
  }
  
  // 加载组件数据
  async loadComponentData(component) {
    if (component.props.datasource) {
      let data = await this.fetchDataSource(component.props.datasource);
      component.setData(data);
    }
  }
}
```

**生命周期阶段**：
1. **创建阶段**：根据 Schema 创建组件实例
2. **挂载阶段**：组件挂载到 DOM，加载数据源
3. **更新阶段**：配置变更触发组件更新
4. **销毁阶段**：组件卸载，清理资源

---

## 🎨 设计模式在架构中的应用

### 1. 单例模式

**应用场景**：Dashboard 核心类、Schema 注册中心

**实现方式**：
```javascript
// Dashboard 单例
class Dashboard {
  static instance = null;
  
  static getInstance() {
    if (!Dashboard.instance) {
      Dashboard.instance = new Dashboard();
    }
    return Dashboard.instance;
  }
}
```

**作用**：确保全局唯一实例，统一管理大屏生命周期

---

### 2. 工厂模式

**应用场景**：组件创建、数据源创建

**实现方式**：
```javascript
// 组件工厂
function createAppComponent(config) {
  const { node, dashboard, scene } = config;
  const Component = getComponent(node.type);
  return new Component({ node, dashboard, scene });
}

// 数据源工厂
function createDataSource(sourceType) {
  switch(sourceType) {
    case 'application': return new ApplicationDataSource();
    case 'host': return new HostDataSource();
    case 'network': return new NetworkDataSource();
    default: throw new Error('Unknown data source type');
  }
}
```

**作用**：统一创建入口，降低创建复杂度

---

### 3. 观察者模式

**应用场景**：组件状态变更、事件总线

**实现方式**：
```javascript
// 事件总线
class EventBus {
  constructor() {
    this.events = {};
  }
  
  on(event, callback) {
    if (!this.events[event]) {
      this.events[event] = [];
    }
    this.events[event].push(callback);
  }
  
  emit(event, data) {
    if (this.events[event]) {
      this.events[event].forEach(callback => callback(data));
    }
  }
}
```

**作用**：实现组件间解耦通信，支持全局联动

---

### 4. 代理模式

**应用场景**：组件属性代理、数据源代理

**实现方式**：
```javascript
// 属性代理
function createPropertyProxy(target, handler) {
  return new Proxy(target, {
    set(obj, prop, value) {
      // 拦截属性更新
      if (handler.beforeSet) {
        value = handler.beforeSet(prop, value);
      }
      obj[prop] = value;
      // 触发更新
      if (handler.onSet) {
        handler.onSet(prop, value);
      }
      return true;
    }
  });
}
```

**作用**：属性操作规范可控，拦截属性更新

---

### 5. 适配器模式

**应用场景**：数据源适配、组件接口适配

**实现方式**：
```javascript
// 数据源适配器
class DataSourceAdapter {
  adapt(data, sourceFormat, targetFormat) {
    // 格式转换
    let converted = this.convertFormat(data, sourceFormat, targetFormat);
    // 字段映射
    converted = this.mapFields(converted);
    // 数据清洗
    converted = this.cleanData(converted);
    return converted;
  }
}
```

**作用**：统一数据接口，屏蔽底层数据差异

---

### 6. 装饰器模式

**应用场景**：Layout 渲染、组件功能增强

**实现方式**：
```javascript
// Layout 装饰器
function withLayout(Component) {
  return {
    ...Component,
    render() {
      return (
        <LayoutContainer>
          <Component {...this.$props} />
        </LayoutContainer>
      );
    }
  };
}
```

**作用**：不侵入业务组件代码，实现功能增强

---

## 📊 架构设计原则

### 1. 分层原则

**清晰分层**：
- **表现层**：负责用户交互和界面展示
- **业务层**：负责业务逻辑和核心功能
- **数据层**：负责数据管理和状态同步
- **支撑层**：提供工具和基础设施

**职责分离**：每层只关注自己的职责，降低耦合度

---

### 2. 高内聚低耦合

**高内聚**：
- 相关功能集中在同一模块
- 组件内部功能紧密相关
- Schema 定义与组件实现绑定

**低耦合**：
- 模块间通过接口通信
- 使用事件总线解耦组件
- 依赖注入而非硬编码依赖

---

### 3. 可扩展性

**扩展机制**：
- **插件机制**：支持功能插件化扩展
- **组件注册**：动态注册新组件
- **Schema 扩展**：通过 Schema 扩展配置项

**扩展方式**：
- 新增组件：添加组件文件和 Schema 定义
- 新增功能：通过插件机制注入
- 新增数据源：实现数据源接口

---

### 4. 可维护性

**维护策略**：
- **清晰结构**：目录结构清晰，职责明确
- **规范命名**：统一的命名规范
- **完善文档**：代码注释和架构文档
- **测试覆盖**：关键模块有测试保障

---

## 🔗 相关文档

- [大屏低代码编辑.md](./大屏低代码编辑.md) - 大屏项目经验总结
- [前端架构.md](../../06-工程化/前端架构.md) - 前端架构设计核心体系
- [Design pattern.md](../../01-JavaScript基础/Design pattern.md) - JavaScript 设计模式详解

