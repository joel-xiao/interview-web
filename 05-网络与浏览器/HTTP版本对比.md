# HTTP 版本差异对比

> HTTP/1.1、HTTP/2、HTTP/3 核心差异与演进

---

## 📚 目录

- [一、HTTP 版本演进](#一http-版本演进)
- [二、HTTP/1.1](#二http11)
- [三、HTTP/2](#三http2)
- [四、HTTP/3](#四http3)
- [五、版本对比总结](#五版本对比总结)

---

## 一、HTTP 版本演进

### 1.1 发展时间线

```
1991年：HTTP/0.9
    ↓
1996年：HTTP/1.0
    ↓
1997年：HTTP/1.1（至今仍广泛使用）
    ↓
2015年：HTTP/2（多路复用）
    ↓
2020年：HTTP/3（基于 QUIC）
```

### 1.2 核心演进目标

- **性能优化**：减少延迟、提高吞吐量
- **安全性**：加密传输、防止中间人攻击
- **可靠性**：连接复用、错误恢复

---

## 二、HTTP/1.1

### 2.1 核心特性

#### 请求流程

```
浏览器发起请求
┌─────────────┐
│ HTTP/1.1     │
└─────────────┘
        │
        ▼
┌─────────────────────┐
│ 单 TCP 连接          │
│ 请求1 → 队头阻塞     │
│ 请求2 → 等待请求1完成 │
│ 请求3 → 等待请求1完成 │
└─────────────────────┘
        │
        ▼
服务器响应依次返回
- 低效，多请求延迟累加
```

### 2.2 主要问题

#### 1. 队头阻塞（Head-of-Line Blocking）

**问题**：同一 TCP 连接中，前面的请求阻塞后面的请求

```js
// 请求1 需要 2秒
fetch('/api/data1')  // 阻塞中...

// 请求2 需要 0.1秒，但必须等待请求1完成
fetch('/api/data2')  // 等待中...
```

**影响**：多个请求串行执行，总延迟 = 所有请求延迟之和

#### 2. 连接数限制

- **浏览器限制**：同一域名最多 6 个并发连接
- **解决方案**：域名分片（domain sharding）

#### 3. 无头部压缩

- 每次请求都发送完整的 HTTP 头部
- 头部信息重复传输，浪费带宽

### 2.3 优化方案

1. **Keep-Alive**：复用 TCP 连接
2. **管道化（Pipelining）**：允许发送多个请求，但响应仍需按顺序返回
3. **域名分片**：使用多个域名增加并发连接数

---

## 三、HTTP/2

### 3.1 核心特性

#### 请求流程

```
┌─────────────┐
│ HTTP/2       │
└─────────────┘
        │
        ▼
┌─────────────────────┐
│ 单 TCP 连接，多路复用 │
│ 数据被分成二进制帧   │
│ 帧可并行传输         │
└─────────────────────┘
        │
        ▼
服务器响应多帧交错返回
- 队头阻塞问题解决
- 支持 Server Push
```

### 3.2 主要改进

#### 1. 多路复用（Multiplexing）

**核心**：在单个 TCP 连接上并行传输多个请求/响应

```js
// HTTP/1.1：串行（总时间 = 2 + 0.1 = 2.1秒）
fetch('/api/data1')  // 2秒
fetch('/api/data2')  // 0.1秒（等待中）

// HTTP/2：并行（总时间 = max(2, 0.1) = 2秒）
fetch('/api/data1')  // 2秒
fetch('/api/data2')  // 0.1秒（并行执行）
```

**优势**：
- ✅ 解决队头阻塞问题
- ✅ 提高连接利用率
- ✅ 减少延迟

#### 2. 二进制分帧（Binary Framing）

**HTTP/1.1**：文本格式
```
GET /api/data HTTP/1.1
Host: example.com
```

**HTTP/2**：二进制帧
```
[帧头][帧数据]
- 帧类型：HEADERS、DATA、SETTINGS 等
- 流标识符：标识请求/响应流
```

**优势**：
- ✅ 解析更高效
- ✅ 支持多路复用
- ✅ 减少传输开销

#### 3. 头部压缩（HPACK）

**HTTP/1.1**：每次发送完整头部
```
GET /api/data HTTP/1.1
Host: example.com
User-Agent: Mozilla/5.0...
Cookie: session=abc123...
```

**HTTP/2**：使用 HPACK 压缩
- 静态表：常用头部字段
- 动态表：自定义头部字段
- 增量编码：只传输变化部分

**优势**：
- ✅ 减少头部大小（通常减少 50-90%）
- ✅ 提高传输效率

#### 4. 服务器推送（Server Push）

**HTTP/1.1**：客户端请求资源
```
1. 请求 HTML
2. 解析 HTML，发现需要 CSS
3. 请求 CSS
4. 解析 HTML，发现需要 JS
5. 请求 JS
```

**HTTP/2**：服务器主动推送
```
1. 请求 HTML
2. 服务器同时推送 CSS 和 JS
```

**优势**：
- ✅ 减少往返次数（RTT）
- ✅ 提前加载资源

### 3.3 仍存在的问题

#### TCP 队头阻塞

虽然解决了 HTTP 层面的队头阻塞，但 **TCP 层面的队头阻塞仍然存在**：

```
TCP 数据包丢失
    ↓
等待重传
    ↓
阻塞所有 HTTP/2 流
```

---

## 四、HTTP/3

### 4.1 核心特性

#### 请求流程

```
┌─────────────┐
│ HTTP/3       │
└─────────────┘
        │
        ▼
┌─────────────────────┐
│ 基于 QUIC (UDP)      │
│ 多路复用 + 加密      │
│ 连接建立快，低延迟   │
└─────────────────────┘
        │
        ▼
- 解决 TCP 队头阻塞
- 0-RTT 连接建立
- 内置加密（TLS 1.3）
```

### 4.2 主要改进

#### 1. 基于 QUIC（UDP）

**HTTP/2**：基于 TCP
- TCP 队头阻塞问题
- 连接建立需要 3 次握手

**HTTP/3**：基于 QUIC（UDP）
- ✅ 解决 TCP 队头阻塞
- ✅ 0-RTT 连接建立（已连接过）
- ✅ 连接迁移（切换网络不中断）

#### 2. 内置加密

**HTTP/2**：可选加密（HTTPS）
**HTTP/3**：强制加密（TLS 1.3）
- ✅ 所有数据默认加密
- ✅ 防止中间人攻击

#### 3. 多路复用改进

**HTTP/2**：TCP 层队头阻塞
**HTTP/3**：QUIC 流独立
- ✅ 每个流独立处理
- ✅ 一个流阻塞不影响其他流

### 4.3 QUIC 协议优势

1. **快速连接**：0-RTT（已连接）或 1-RTT（首次连接）
2. **连接迁移**：切换网络（WiFi → 4G）不中断
3. **错误恢复**：更好的拥塞控制和错误恢复机制

---

## 五、版本对比总结

| 特性 | HTTP/1.1 | HTTP/2 | HTTP/3 |
|------|---------|-------|--------|
| **传输协议** | TCP | TCP | QUIC (UDP) |
| **多路复用** | ❌ | ✅ | ✅ |
| **头部压缩** | ❌ | ✅ (HPACK) | ✅ (QPACK) |
| **服务器推送** | ❌ | ✅ | ✅ |
| **队头阻塞** | HTTP 层阻塞 | TCP 层阻塞 | ✅ 已解决 |
| **加密** | 可选 (HTTPS) | 可选 (HTTPS) | 强制 (TLS 1.3) |
| **连接建立** | 3 次握手 | 3 次握手 | 0-RTT / 1-RTT |
| **连接迁移** | ❌ | ❌ | ✅ |
| **浏览器支持** | ✅ 全部 | ✅ 全部 | ⚠️ 部分 |

---

## 🎯 实际应用建议

### 选择建议

1. **HTTP/1.1**：
   - 简单场景
   - 兼容性要求高
   - 资源较少

2. **HTTP/2**：
   - 现代浏览器
   - 多资源加载
   - 需要服务器推送

3. **HTTP/3**：
   - 最新浏览器
   - 高延迟网络
   - 移动网络场景

### 性能对比

```
HTTP/1.1：100% 基准
HTTP/2：  约 30-50% 性能提升
HTTP/3：  约 50-70% 性能提升（高延迟网络）
```

---

## 📖 相关资源

- [MDN: HTTP/2](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Evolution_of_HTTP)
- [HTTP/3 规范](https://httpwg.org/specs/rfc9114.html)

---

**相关文件**：
- [网络协议分层模型.md](./网络协议分层模型.md) - OSI 七层模型
- [浏览器渲染原理.md](./浏览器渲染原理.md) - 浏览器渲染机制
